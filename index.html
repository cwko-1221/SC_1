<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é¦™æ¸¯è¡Œæ¥­é˜²è¡›æˆ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');

        :root {
            --app-height: 100dvh;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            height: var(--app-height);
            overflow: hidden;
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #0f172a;
            color: white;
            /* é—œéµ CSSï¼šç¦æ­¢ç€è¦½å™¨é è¨­è§¸æ§è¡Œç‚ºï¼Œé˜²æ­¢ iPad ç¸®æ”¾ */
            touch-action: none; 
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            display: flex;
            flex-direction: column;
        }

        #gameContainer {
            position: relative;
            flex: 1;
            width: 100%;
            overflow: hidden;
            background: radial-gradient(circle at bottom center, #1e293b, #0f172a);
        }
        
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            100% { transform: translate(0, 0) rotate(0); }
        }
        
        .shake {
            animation: shake 0.5s;
            animation-iteration-count: 1;
        }

        .damage-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 0, 0, 0.3);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 5;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        /* Shop Area */
        #shopPanel {
            height: 120px;
            width: 100%;
            background-color: #0f172a;
            border-top: 2px solid #334155;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            padding: 8px;
            padding-bottom: env(safe-area-inset-bottom, 8px);
            flex-shrink: 0;
            z-index: 20;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        .shop-btn {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #94a3b8;
            transition: all 0.1s;
            user-select: none;
            position: relative;
            overflow: hidden;
            padding: 2px;
            -webkit-tap-highlight-color: transparent;
        }

        .shop-btn:active { transform: scale(0.96); }

        .shop-btn.affordable {
            background: linear-gradient(135deg, #b91c1c, #ef4444); 
            color: white;
            border-color: #fca5a5;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.4);
        }

        .shop-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #0f172a;
        }

        .shop-icon { font-size: clamp(1rem, 4vw, 1.4rem); line-height: 1.2; margin-bottom: 2px; }
        .shop-info { font-size: clamp(0.6rem, 3vw, 0.8rem); font-weight: bold; line-height: 1.1; text-align: center; }
        .shop-cost { font-size: clamp(0.6rem, 3vw, 0.75rem); color: #fbbf24; font-weight: bold; }

        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            background: rgba(0, 0, 0, 0.95);
            z-index: 50;
            backdrop-filter: blur(8px);
            padding: 20px;
        }

        .hidden { display: none !important; }

        .btn-main {
            background: linear-gradient(45deg, #dc2626, #991b1b);
            border: none;
            padding: 15px 40px;
            color: white;
            font-size: 1.4rem;
            border-radius: 50px;
            font-weight: bold;
            box-shadow: 0 4px 20px rgba(220, 38, 38, 0.6);
            margin-top: 20px;
            transition: transform 0.1s;
            text-transform: uppercase;
            letter-spacing: 2px;
            white-space: nowrap;
        }
        .btn-main:active { transform: scale(0.95); }

        #hud {
            position: absolute;
            top: env(safe-area-inset-top, 10px);
            left: 10px; right: 10px;
            display: flex; justify-content: space-between;
            pointer-events: auto; /* Allow clicking buttons */
            z-index: 10;
            font-size: clamp(1rem, 4vw, 1.4rem);
            font-weight: bold;
            text-shadow: 2px 2px 2px rgba(0,0,0,0.8);
        }

        .gold-display { color: #fbbf24; }
        .wave-display { color: #f87171; }
        .lives-display { color: #f43f5e; }
        
        .music-btn {
            background: rgba(0,0,0,0.5);
            border: 1px solid #fff;
            border-radius: 50%;
            width: 36px; height: 36px;
            font-size: 18px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
            pointer-events: auto;
            margin-top: 5px;
            margin-left: auto; /* Align to right */
        }
        
        .wave-notification {
            position: absolute;
            top: 40%; width: 100%; text-align: center;
            font-size: clamp(3rem, 10vw, 5rem);
            font-weight: 900;
            color: #ef4444;
            text-shadow: 0 0 20px rgba(0,0,0,0.8);
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
            z-index: 30;
            letter-spacing: 5px;
        }

        /* Quiz Styles */
        .quiz-container {
            width: 95%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            /* å…è¨±åœ¨ Quiz å€åŸŸæ»‘å‹•ï¼Œä½†ä¸ç¸®æ”¾ */
            touch-action: pan-y; 
        }

        .quiz-btn {
            background: white; color: #1e293b;
            width: 100%; padding: 12px; margin: 6px 0;
            border-radius: 8px; font-size: 0.95rem; font-weight: bold;
            text-align: left; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            cursor: pointer;
            white-space: normal; /* Allow text wrap */
            line-height: 1.4;
        }
        .quiz-btn:active { transform: scale(0.98); background: #f1f5f9; }

        .damage-text {
            position: absolute; color: #fff; font-weight: bold;
            pointer-events: none; animation: floatUp 0.8s ease-out forwards;
            font-size: 20px; z-index: 5;
            text-shadow: 0 0 5px #ff0000, 1px 1px 0 #000;
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-40px) scale(1.2); }
        }
    </style>
</head>
<body>

    <audio id="bgMusic" loop preload="auto">
        <source src="https://ia800300.us.archive.org/5/items/EricSkiffResistorAnthems/01_A_Night_Of_Dizzy_Spells.mp3" type="audio/mpeg">
    </audio>

    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="damageOverlay" class="damage-overlay"></div>
        
        <div id="hud">
            <div>
                <div class="lives-display">â¤ï¸ <span id="livesVal">5</span></div>
                <div class="wave-display text-sm">WAVE <span id="waveVal">1</span>/20</div>
            </div>
            <div class="text-right">
                <div class="gold-display">ğŸ’° <span id="goldVal">0</span></div>
                <button id="musicToggle" class="music-btn" onclick="toggleMusic()">ğŸµ</button>
            </div>
        </div>
        
        <div id="waveNotify" class="wave-notification">WAVE 1</div>

        <div id="startScreen" class="overlay">
            <h1 class="text-4xl md:text-5xl font-black mb-4 text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-orange-500 text-center">ç§‘å­¸çŸ¥è­˜é˜²è¡›æˆ°<br><span class="text-2xl text-white/80">Science Defense</span></h1>
            <div class="bg-black/60 p-6 rounded-lg text-center backdrop-blur-sm border border-red-900 w-full max-w-md">
                <p class="text-gray-300 mb-2 font-bold text-lg">âš ï¸ ä»»å‹™ç›®æ¨™ / Mission</p>
                <ul class="text-left text-sm text-gray-400 space-y-2 mb-6 list-disc pl-5">
                    <li>ä½ æœ‰ <span class="text-red-400 font-bold">5 é¡†ç”Ÿå‘½</span> (5 Lives)</li>
                    <li>ç”Ÿå­˜ç›´åˆ° <span class="text-yellow-400 font-bold">ç¬¬ 20 æ³¢</span> (Survive 20 Waves)</li>
                    <li>å›ç­”<span class="text-green-400 font-bold">ç§‘å­¸é¡Œç›®</span>è³ºéŒ¢ (Answer Science Quiz)</li>
                    <li>æ€ªç‰©æœƒéš¨æ™‚é–“è®Šå¼· (Enemies get stronger)</li>
                </ul>
                <button class="btn-main" onclick="startGame()">é–‹å§‹ / START</button>
            </div>
        </div>

        <div id="quizScreen" class="overlay hidden">
            <div class="bg-slate-800 p-6 rounded-xl border border-red-500/30 w-full max-w-2xl text-center shadow-2xl shadow-red-900/20 quiz-container">
                <h2 class="text-2xl font-bold mb-1 text-yellow-400">æ³¢æ•¸å®Œæˆï¼<br><span class="text-sm text-white/70">Wave Cleared!</span></h2>
                <div class="text-green-400 text-lg font-bold mb-4">çå‹µ/Reward: $<span id="quizRewardVal">0</span></div>
                
                <div id="questionText" class="text-lg md:text-xl font-bold mb-6 text-white text-left leading-relaxed border-b border-slate-600 pb-4">
                    é¡Œç›®è¼‰å…¥ä¸­...
                </div>
                
                <div id="answerOptions" class="flex flex-col w-full"></div>
            </div>
        </div>

        <div id="gameOverScreen" class="overlay hidden">
            <h1 class="text-6xl font-black mb-4 text-red-600 tracking-widest text-center">æ•—åŒ—<br><span class="text-3xl">DEFEAT</span></h1>
            <p class="text-2xl mb-8">å­˜æ´»æ³¢æ•¸ (Wave): <span id="finalWave">0</span></p>
            <button class="btn-main" onclick="resetGame()">å†è©¦ä¸€æ¬¡ / Retry</button>
        </div>

        <div id="victoryScreen" class="overlay hidden">
            <h1 class="text-5xl md:text-6xl font-black mb-4 text-yellow-400 tracking-widest text-center drop-shadow-[0_0_15px_rgba(250,204,21,0.8)]">ä»»å‹™å®Œæˆ!<br><span class="text-3xl">VICTORY</span></h1>
            <div class="text-center mb-8">
                <p class="text-2xl text-white mb-2">ä½ æˆåŠŸå®ˆä½äº† 20 æ³¢æ”»æ“Š</p>
                <p class="text-xl text-gray-300">Science Master!</p>
            </div>
            <button class="btn-main bg-gradient-to-r from-yellow-500 to-orange-500 border-yellow-300" onclick="resetGame()">å†æ¬¡æŒ‘æˆ° / Replay</button>
        </div>
    </div>

    <div id="shopPanel">
        <button class="shop-btn" id="btn-count" onclick="buyUpgrade('count')">
            <div class="shop-icon">ğŸ¹ x<span id="val-count">1</span></div>
            <div class="shop-info">æ•¸é‡<br><span class="text-[0.6rem]">Count</span></div>
            <div class="shop-cost">$<span id="cost-count">100</span></div>
        </button>

        <button class="shop-btn" id="btn-speed" onclick="buyUpgrade('speed')">
            <div class="shop-icon">âš¡ <span id="val-speed">1</span></div>
            <div class="shop-info">é€Ÿåº¦<br><span class="text-[0.6rem]">Speed</span></div>
            <div class="shop-cost">$<span id="cost-speed">50</span></div>
        </button>

        <button class="shop-btn" id="btn-power" onclick="buyUpgrade('power')">
            <div class="shop-icon">ğŸ’ª <span id="val-power">10</span></div>
            <div class="shop-info">åŠ›é‡<br><span class="text-[0.6rem]">Power</span></div>
            <div class="shop-cost">$<span id="cost-power">80</span></div>
        </button>

        <button class="shop-btn" id="btn-pierce" onclick="buyUpgrade('pierce')">
            <div class="shop-icon">ğŸ”© <span id="val-pierce">1</span></div>
            <div class="shop-info">ç©¿é€<br><span class="text-[0.6rem]">Pierce</span></div>
            <div class="shop-cost">$<span id="cost-pierce">200</span></div>
        </button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameContainer = document.getElementById('gameContainer');
        const damageOverlay = document.getElementById('damageOverlay');
        const bgMusic = document.getElementById('bgMusic');
        let isMusicPlaying = false;

        // --- Quiz Data (Bilingual: Scientific Inquiry) ---
        const quizData = [
            {
                q: "1. å»ºç«‹æ–°ç§‘å­¸çŸ¥è­˜çš„éç¨‹ï¼Œé€šå¸¸æ˜¯å¾å“ªä¸€å€‹æ­¥é©Ÿé–‹å§‹çš„ï¼Ÿ<br><span class='text-gray-400 text-sm'>Which step does the process of establishing new scientific knowledge usually begin with?</span>",
                options: [
                    "A. æå‡ºå‡è¨­ (Propose a hypothesis)",
                    "B. é€²è¡Œæ¸¬è©¦ (Conduct a test)",
                    "C. è§€å¯Ÿèˆ‡æå• (Observation and asking questions)",
                    "D. åˆ†æèˆ‡åæ€ (Analysis and reflection)"
                ],
                ans: 2 // C
            },
            {
                q: "2. åœ¨ç§‘å­¸æ¢ç©¶ä¸­ï¼Œã€Œå‡è¨­ã€(Hypothesis) çš„å®šç¾©æ˜¯ä»€éº¼ï¼Ÿ<br><span class='text-gray-400 text-sm'>What is the definition of 'Hypothesis' in scientific inquiry?</span>",
                options: [
                    "A. ä¸€å€‹æ°¸é ä¸æœƒæ”¹è®Šçš„çœŸç†<br><span class='text-xs'>An unchanging truth</span>",
                    "B. æ ¹æ“šç†è«–æˆ–ç¶“é©—å°å•é¡Œä½œå‡ºçš„æš«æ™‚æ€§è§£é‡‹<br><span class='text-xs'>A temporary explanation based on theory or experience</span>",
                    "C. å¯¦é©—çµæŸå¾Œå¾—å‡ºçš„æœ€çµ‚çµè«–<br><span class='text-xs'>The final conclusion after experiment</span>",
                    "D. ç§‘å­¸å®¶æ†‘ç©ºæƒ³åƒå‡ºä¾†çš„æ•…äº‹<br><span class='text-xs'>A story imagined by scientists</span>"
                ],
                ans: 1 // B
            },
            {
                q: "3. æ ¹æ“šèª²æœ¬ä¸­çš„æ¼«ç•«å¯¦é©—ï¼Œç‚ºä»€éº¼æª¸æª¬èŒ¶ä¸­çš„å†°å¡ŠèåŒ–å¾Œï¼ŒèŒ¶æ²’æœ‰æº¢å‡ºä¾†ï¼Ÿ<br><span class='text-gray-400 text-sm'>According to the experiment, why didn't the tea overflow after the ice cubes melted?</span>",
                options: [
                    "A. å› ç‚ºå†°èåŒ–æˆæ°´å¾Œï¼Œé«”ç©æœƒæ”¶ç¸®<br><span class='text-xs'>Because ice shrinks in volume when it melts into water</span>",
                    "B. å› ç‚ºå†°èåŒ–æˆæ°´å¾Œï¼Œé«”ç©æœƒè†¨è„¹<br><span class='text-xs'>Because ice expands in volume when it melts into water</span>",
                    "C. å› ç‚ºæ¯å­è®Šå¤§äº†<br><span class='text-xs'>Because the cup got bigger</span>",
                    "D. å› ç‚ºæ°´è¢«è’¸ç™¼äº†<br><span class='text-xs'>Because the water evaporated</span>"
                ],
                ans: 0 // A
            },
            {
                q: "4. åœ¨é©—è­‰ã€Œæ°´çµå†°é«”ç©æœƒå¦‚ä½•è®ŠåŒ–ã€çš„å¯¦é©—ä¸­ï¼Œæ­£ç¢ºçš„æ¸¬è©¦çµæœæ˜¯ä»€éº¼ï¼Ÿ<br><span class='text-gray-400 text-sm'>In the experiment verifying 'how water volume changes when freezing', what is the correct result?</span>",
                options: [
                    "A. æ°´çµå†°å¾Œï¼Œå†°é¢ä½æ–¼åŸä¾†çš„æ°´ä½ï¼ˆæ”¶ç¸®ï¼‰<br><span class='text-xs'>Ice level is lower than original water level (Shrink)</span>",
                    "B. æ°´çµå†°å¾Œï¼Œå†°é¢é«˜æ–¼åŸä¾†çš„æ°´ä½ï¼ˆè†¨è„¹ï¼‰<br><span class='text-xs'>Ice level is higher than original water level (Expand)</span>",
                    "C. æ°´ä½å®Œå…¨æ²’æœ‰è®ŠåŒ–<br><span class='text-xs'>No change in water level</span>",
                    "D. æ°´æœƒè®Šæˆæ°£é«”æ¶ˆå¤±<br><span class='text-xs'>Water turns into gas and disappears</span>"
                ],
                ans: 1 // B
            },
            {
                q: "5. å¦‚æœå¯¦é©—çš„æ¸¬è©¦çµæœä¸æ”¯æŒä½ åŸæœ¬çš„å‡è¨­ï¼Œä½ æ‡‰è©²æ€éº¼åšï¼Ÿ<br><span class='text-gray-400 text-sm'>What should you do if the test results do not support your original hypothesis?</span>",
                options: [
                    "A. ä¿®æ”¹å¯¦é©—æ•¸æ“šè®“å®ƒç¬¦åˆå‡è¨­<br><span class='text-xs'>Modify data to fit the hypothesis</span>",
                    "B. æ”¾æ£„é€™å€‹ç ”ç©¶é¡Œç›®<br><span class='text-xs'>Give up on the research topic</span>",
                    "C. å …æŒåŸæœ¬çš„å‡è¨­æ˜¯å°çš„<br><span class='text-xs'>Insist the hypothesis is correct</span>",
                    "D. æå‡ºä¸€å€‹æ–°çš„å‡è¨­ä¸¦é‡æ–°é€²è¡Œæ¸¬è©¦<br><span class='text-xs'>Propose a new hypothesis and test again</span>"
                ],
                ans: 3 // D
            },
            {
                q: "6. åœ¨ç§‘å­¸æ¢ç©¶æ­¥é©Ÿåœ–ä¸­ï¼Œç·Šæ¥åœ¨ã€Œæå‡ºå‡è¨­ã€ä¹‹å¾Œçš„æ­¥é©Ÿæ˜¯ï¼Ÿ<br><span class='text-gray-400 text-sm'>In the scientific inquiry steps, which step immediately follows 'Proposing a Hypothesis'?</span>",
                options: [
                    "A. è§€å¯Ÿ (Observation)",
                    "B. æ¸¬è©¦ (Test)",
                    "C. çµè«– (Conclusion)",
                    "D. æå• (Asking Questions)"
                ],
                ans: 1 // B
            },
            {
                q: "7. ç‚ºä»€éº¼åœ¨åšæ°´çµå†°å¯¦é©—æ™‚ï¼Œè¦åœ¨æ¯å­ä¸Šç”¨æ©¡çš®ç­‹æ¨™è¨˜æ°´ä½ï¼Ÿ<br><span class='text-gray-400 text-sm'>Why use a rubber band to mark the water level in the freezing experiment?</span>",
                options: [
                    "A. ç‚ºäº†è£é£¾æ¯å­ (Decoration)",
                    "B. ç‚ºäº†é˜²æ­¢æ¯å­ç ´è£‚ (Prevent breakage)",
                    "C. ç‚ºäº†æ¯”è¼ƒçµå†°å‰å¾Œçš„æ°´ä½è®ŠåŒ– (To compare level changes)",
                    "D. ç‚ºäº†é˜²æ­¢æ°´ç‘å‡ºä¾† (Prevent spilling)"
                ],
                ans: 2 // C
            },
            {
                q: "8. åœ¨ã€Œåˆ†æèˆ‡åæ€ã€éšæ®µï¼Œç§‘å­¸å®¶ä¸»è¦æ˜¯åœ¨åšä»€éº¼ï¼Ÿ<br><span class='text-gray-400 text-sm'>What do scientists mainly do in the 'Analysis and Reflection' stage?</span>",
                options: [
                    "A. æº–å‚™å¯¦é©—å™¨æ (Prepare equipment)",
                    "B. è§€å¯Ÿè‡ªç„¶ç¾è±¡ (Observe nature)",
                    "C. åˆ†æçµæœæ˜¯å¦æ”¯æŒå‡è¨­ï¼Œä¸¦æª¢è¨æ¸¬è©¦æ˜¯å¦æº–ç¢º<br><span class='text-xs'>Analyze if results support hypothesis and review accuracy</span>",
                    "D. å¹»æƒ³æœªä¾†çš„ç§‘æŠ€ (Imagine future tech)"
                ],
                ans: 2 // C
            },
            {
                q: "9. å¤ä»£äººçœ‹åˆ°å¾é è™•é§›ä¾†çš„èˆ¹éš»ï¼Œæœƒå…ˆçœ‹åˆ°æ¡…æ†æ‰çœ‹åˆ°èˆ¹èº«ï¼Œé€™è­‰æ˜äº†ä»€éº¼ï¼Ÿ<br><span class='text-gray-400 text-sm'>Ancients saw the mast of a ship before the hull when it approached. What did this prove?</span>",
                options: [
                    "A. åœ°çƒæ˜¯å¹³çš„ (Earth is flat)",
                    "B. æµ·æ°´æ˜¯é€æ˜çš„ (Seawater is transparent)",
                    "C. åœ°é¢ï¼ˆæµ·é¢ï¼‰æ˜¯æœ‰å¼§åº¦çš„ (The surface is curved)",
                    "D. èˆ¹éš»åœ¨ä¸‹æ²‰ (The ship is sinking)"
                ],
                ans: 2 // C
            },
            {
                q: "10. ã€Œåœ°å¹³èªªã€(Flat Earth Theory) æ˜¯æŒ‡å¤ä»£äººç›¸ä¿¡ä»€éº¼ï¼Ÿ<br><span class='text-gray-400 text-sm'>What did people believe in the 'Flat Earth Theory'?</span>",
                options: [
                    "A. åœ°çƒæ˜¯åœ“çš„ (Earth is round)",
                    "B. é™¸åœ°æ˜¯å¹³å¦çš„ï¼Œåœ°é¢æ²’æœ‰å¼§åº¦ (Land is flat with no curvature)",
                    "C. åœ°çƒæ‡¸æµ®åœ¨å¤ªç©ºä¸­ (Earth floats in space)",
                    "D. å¤ªé™½ç¹è‘—åœ°çƒè½‰ (Sun orbits Earth)"
                ],
                ans: 1 // B
            },
            {
                q: "11. å¤å¸Œè‡˜æ•¸å­¸å®¶åŸƒæ‹‰æ‰˜æ–¯ç‰¹å°¼ (Eratosthenes) åˆ©ç”¨ä»€éº¼ç¾è±¡æ¨ç¿»äº†åœ°å¹³èªªï¼Ÿ<br><span class='text-gray-400 text-sm'>What phenomenon did Eratosthenes use to disprove the Flat Earth Theory?</span>",
                options: [
                    "A. æœˆäº®çš„å½¢ç‹€è®ŠåŒ– (Moon phases)",
                    "B. æ˜Ÿæ˜Ÿçš„æ’åˆ— (Star arrangement)",
                    "C. ä¸åŒåŸå¸‚åœ¨åŒä¸€æ™‚é–“çš„å½±å­é•·åº¦ä¸åŒ<br><span class='text-xs'>Different shadow lengths in different cities at the same time</span>",
                    "D. æ½®æ±çš„æ¼²é€€ (Tides)"
                ],
                ans: 2 // C
            },
            {
                q: "12. ç¾ä»£ç§‘æŠ€ä¸­ï¼Œå“ªä¸€é …æä¾›äº†åœ°çƒæ˜¯åœ“çƒé«”çš„ã€Œæœ€ç›´æ¥ã€è­‰æ“šï¼Ÿ<br><span class='text-gray-400 text-sm'>Which modern technology provides the 'most direct' evidence that Earth is a sphere?</span>",
                options: [
                    "A. äººé€ è¡›æ˜Ÿå¾å¤ªç©ºæ‹æ”çš„ç…§ç‰‡ (Satellite photos)",
                    "B. é£›æ©Ÿçš„é£›è¡Œç´€éŒ„ (Flight records)",
                    "C. ç’°éŠä¸–ç•Œçš„èˆªæµ·åœ– (Navigation charts)",
                    "D. é«˜å€ç‡æœ›é é¡ (High-power telescopes)"
                ],
                ans: 0 // A
            },
            {
                q: "13. é—œæ–¼ç§‘å­¸çŸ¥è­˜çš„ç‰¹æ€§ï¼Œä¸‹åˆ—æ•˜è¿°ä½•è€…æ­£ç¢ºï¼Ÿ<br><span class='text-gray-400 text-sm'>Which statement about scientific knowledge is correct?</span>",
                options: [
                    "A. ç§‘å­¸çŸ¥è­˜æ°¸é ä¸æœƒæ”¹è®Š (Never changes)",
                    "B. ç•¶æœ‰æ–°è­‰æ“šå‡ºç¾æ™‚ï¼ŒèˆŠçš„ç§‘å­¸çŸ¥è­˜å¯èƒ½æœƒè¢«æ¨ç¿»æˆ–ä¿®æ­£<br><span class='text-xs'>Old knowledge may be revised when new evidence appears</span>",
                    "C. å¤ä»£çš„ç§‘å­¸çŸ¥è­˜ä¸€å®šæ¯”ç¾ä»£æº–ç¢º (Ancient knowledge is better)",
                    "D. ç§‘å­¸çŸ¥è­˜ä¸éœ€è¦è­‰æ“šæ”¯æŒ (No evidence needed)"
                ],
                ans: 1 // B
            },
            {
                q: "14. ç§‘å­¸å®¶æ‡‰å…·å‚™ã€Œæ™‚åˆ»ä¿æŒå­˜ç–‘ã€(Always have doubts) çš„æ…‹åº¦ï¼Œæ„æ€æ˜¯ï¼Ÿ<br><span class='text-gray-400 text-sm'>What does it mean for scientists to 'Always have doubts'?</span>",
                options: [
                    "A. æ‡·ç–‘è‡ªå·±ä»€éº¼éƒ½åšä¸åˆ° (Self-doubt)",
                    "B. æ‹’çµ•ç›¸ä¿¡ä»»ä½•äººèªªçš„è©± (Refuse to believe anyone)",
                    "C. ä¸è¼•æ˜“ç›¸ä¿¡äº‹ç‰©ï¼Œå¤šåŠ æ€è€ƒä¸¦é©—è­‰äº‹å¯¦<br><span class='text-xs'>Think critically and verify facts before believing</span>",
                    "D. ç¸½æ˜¯æŒ‘åˆ¥äººçš„æ¯›ç—… (Nitpicking)"
                ],
                ans: 2 // C
            },
            {
                q: "15. ç•¶èª²æœ¬æåˆ°çš„ã€Œæ¬Šå¨æˆ–èˆŠæœ‰è§€å¿µã€èˆ‡ä½ çš„å¯¦é©—è­‰æ“šè¡çªæ™‚ï¼Œæ‡‰æŠ±æŒå“ªç¨®æ…‹åº¦ï¼Ÿ<br><span class='text-gray-400 text-sm'>What attitude should you have when 'authority' conflicts with your experimental evidence?</span>",
                options: [
                    "A. ä¿®æ”¹è­‰æ“šä»¥ç¬¦åˆæ¬Šå¨èªªæ³• (Modify evidence)",
                    "B. ä¸è¢«æ¬Šå¨æˆ–èˆŠä¿¡å¿µæŸç¸›ï¼Œå‹‡æ•¢æŒ‘æˆ°<br><span class='text-xs'>Don't be bound by authority; challenge bravely</span>",
                    "C. å¿½ç•¥è‡ªå·±çš„ç™¼ç¾ (Ignore findings)",
                    "D. åœæ­¢é€²è¡Œå¯¦é©— (Stop experiment)"
                ],
                ans: 1 // B
            },
            {
                q: "16. ã€Œå°Šé‡è­‰æ“šå’Œäº‹å¯¦ã€(Respect evidence and facts) æ˜¯æŒ‡ï¼Ÿ<br><span class='text-gray-400 text-sm'>What does 'Respect evidence and facts' mean?</span>",
                options: [
                    "A. åªç›¸ä¿¡è‡ªå·±å–œæ­¡çš„æ•¸æ“š (Only data you like)",
                    "B. ç›¸ä¿¡å®¢è§€æ•¸æ“šå’Œå¯¦é©—çµæœï¼Œä¸å—ä¸»è§€åè¦‹å½±éŸ¿<br><span class='text-xs'>Trust objective data, avoid bias</span>",
                    "C. è½å¾è€å¸«çš„æ„è¦‹ï¼Œä¸ç®¡å¯¦é©—çµæœå¦‚ä½• (Obey teacher blindly)",
                    "D. å‰µé€ æ•¸æ“šä¾†æ”¯æŒè‡ªå·±çš„æƒ³æ³• (Fabricate data)"
                ],
                ans: 1 // B
            },
            {
                q: "17. ç§‘å­¸å®¶éœ€è¦ã€Œæƒ³åƒåŠ›å’Œå‰µé€ åŠ›ã€ä¸»è¦æ˜¯ç‚ºäº†ï¼Ÿ<br><span class='text-gray-400 text-sm'>Why do scientists need 'Imagination and Creativity'?</span>",
                options: [
                    "A. ç·¨é€ å¥½è½çš„æ•…äº‹ (Make up stories)",
                    "B. ç•«å‡ºæ¼‚äº®çš„åœ–ç•« (Draw pictures)",
                    "C. é‹ç”¨å‰µæ–°æ€ç¶­å’Œæ–°æ–¹æ³•ä¾†è§£æ±ºå•é¡Œ<br><span class='text-xs'>Use innovative thinking to solve problems</span>",
                    "D. è®“å¯¦é©—éç¨‹è®Šå¾—å¥½ç© (Make it fun)"
                ],
                ans: 2 // C
            },
            {
                q: "18. åœ¨èª²æœ¬çš„ç·´ç¿’ä¸­ï¼Œè§€å¯Ÿåˆ°ã€Œé€™å…©éš»é³¥çœ‹èµ·ä¾†å¾ˆåƒï¼Œä½†å–™çš„å½¢ç‹€ä¸åŒã€ï¼Œé€™æ˜¯è¡¨ç¾äº†å“ªç¨®ç§‘å­¸æ…‹åº¦ï¼Ÿ<br><span class='text-gray-400 text-sm'>Noticing 'birds look alike but have different beaks' shows which attitude?</span>",
                options: [
                    "A. ç´°å¿ƒè§€å¯Ÿ (Be observant)",
                    "B. åš´è¬¹æ¸¬è©¦ (Rigorous testing)",
                    "C. æ™‚åˆ»å­˜ç–‘ (Always doubt)",
                    "D. å°Šé‡æ¬Šå¨ (Respect authority)"
                ],
                ans: 0 // A
            },
            {
                q: "19. é€²è¡Œç§‘å­¸å¯¦é©—æ™‚ï¼Œç‚ºä»€éº¼éœ€è¦ã€Œåš´è¬¹çš„æ¸¬è©¦å’Œæ¨ç†ã€ï¼Ÿ<br><span class='text-gray-400 text-sm'>Why is 'Rigorous testing and reasoning' needed in experiments?</span>",
                options: [
                    "A. ç‚ºäº†è®“å¯¦é©—æ™‚é–“æ‹–é•· (To make it longer)",
                    "B. ç‚ºäº†ç¢ºä¿åˆ†æè©³ç´°ä¸”çµè«–æœ‰æ•ˆ<br><span class='text-xs'>To ensure detailed analysis and valid conclusions</span>",
                    "C. ç‚ºäº†æ¶ˆè€—å¯¦é©—ææ–™ (To use up materials)",
                    "D. ç‚ºäº†è®“åˆ¥äººçœ‹ä¸æ‡‚ (To confuse others)"
                ],
                ans: 1 // B
            },
            {
                q: "20. ç§‘å­¸æ¢ç©¶çš„æ­£ç¢ºé †åºæ’åˆ—æ‡‰ç‚ºï¼š<br><span class='text-gray-400 text-sm'>Correct order of Scientific Inquiry:</span><br>(1) æ¸¬è©¦ Test<br>(2) åˆ†æ Analysis<br>(3) è§€å¯Ÿ Observation<br>(4) å‡è¨­ Hypothesis",
                options: [
                    "A. 3 â†’ 1 â†’ 4 â†’ 2",
                    "B. 3 â†’ 4 â†’ 1 â†’ 2",
                    "C. 4 â†’ 3 â†’ 1 â†’ 2",
                    "D. 1 â†’ 2 â†’ 3 â†’ 4"
                ],
                ans: 1 // B
            }
        ];

        // Game State
        let gameState = 'MENU'; 
        let lastTime = 0;
        let animationId = null; 
        let bossSpawned = false; 
        const MAX_WAVE = 20;
        let availableQuestions = []; 

        // Scaling Factors
        let gameScale = 1;
        let speedScale = 1;

        // Player Stats
        const player = {
            x: 0, 
            y: 0, 
            angle: -Math.PI / 2,
            gold: 0,
            wave: 1,
            lives: 5,
            stats: {
                count: 1,
                speed: 14, 
                power: 10,
                fireRate: 350,
                pierce: 1
            },
            upgrades: {
                count: { level: 1, cost: 200, costMult: 2.5 },
                speed: { level: 1, cost: 80, costMult: 1.6 },
                power: { level: 1, cost: 100, costMult: 1.5 },
                pierce: { level: 1, cost: 300, costMult: 3.0 }
            }
        };

        // Entities
        let projectiles = [];
        let enemies = [];
        let particles = [];
        
        // Input & Aiming
        let targetX = 0;
        let targetY = 0;
        let isInputActive = false;
        let lastShotTime = 0;

        // Wave Logic
        let spawnTimer = 0;
        let spawnInterval = 1000;
        let enemiesToSpawn = 0;

        // Enemy Types
        const ENEMY_TYPES = {
            NORMAL: { id: 'normal', emoji: 'ğŸ‘¾', hpMult: 1.0, speedMult: 1.0, radius: 20, color: '#ef4444' },
            FAST:   { id: 'fast',   emoji: 'ğŸ¦‡', hpMult: 0.6, speedMult: 1.8, radius: 15, color: '#a855f7', zigzag: true }, 
            TANK:   { id: 'tank',   emoji: 'ğŸ‘¹', hpMult: 3.5, speedMult: 0.6, radius: 28, color: '#166534' }, 
            BOSS:   { id: 'boss',   emoji: 'ğŸ’€', hpMult: 15.0, speedMult: 0.35, radius: 50, color: '#000000' }
        };

        // --- Initialization & Resizing (Dynamic Scaling) ---
        function resize() {
            const rect = gameContainer.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            
            // iPad / Mobile Adaption
            gameScale = Math.min(canvas.width / 390, 1.5); 
            if(gameScale < 0.8) gameScale = 0.8;

            // Height scaling for consistent gameplay across devices
            speedScale = canvas.height / 800;

            player.x = canvas.width / 2;
            player.y = canvas.height - (50 * gameScale);
            
            if (gameState === 'MENU') {
                targetX = player.x;
                targetY = 0;
            }
        }
        
        window.addEventListener('resize', resize);
        resize();

        // --- Music Control ---
        function toggleMusic() {
            const btn = document.getElementById('musicToggle');
            if (bgMusic.paused) {
                // Try to play
                bgMusic.play().then(() => {
                    btn.innerText = 'ğŸµ';
                    isMusicPlaying = true;
                }).catch(e => {
                    console.error("Music play failed:", e);
                    // Add listener to retry on next click
                    document.addEventListener('click', () => bgMusic.play(), { once: true });
                });
            } else {
                bgMusic.pause();
                btn.innerText = 'ğŸ”‡';
                isMusicPlaying = false;
            }
        }

        // --- Input Handlers ---
        function updateAim(clientX, clientY) {
            const rect = canvas.getBoundingClientRect();
            targetX = clientX - rect.left;
            targetY = clientY - rect.top;
        }

        function calculateAngle() {
             const dx = targetX - player.x;
             const dy = targetY - player.y;
             player.angle = Math.atan2(dy, dx);
        }

        function inputStart(e) {
            // Check if clicking HUD buttons (like music)
            if (e.target.closest('#hud')) return;

            if (gameState !== 'PLAYING') return;
            isInputActive = true;
            let cx = e.touches ? e.touches[0].clientX : e.clientX;
            let cy = e.touches ? e.touches[0].clientY : e.clientY;
            updateAim(cx, cy);
            calculateAngle();
            tryShoot(Date.now());
        }

        function inputMove(e) {
            if (gameState !== 'PLAYING') return;
            let cx = e.touches ? e.touches[0].clientX : e.clientX;
            let cy = e.touches ? e.touches[0].clientY : e.clientY;
            updateAim(cx, cy);
            calculateAngle();
        }

        function inputEnd() { isInputActive = false; }

        canvas.addEventListener('mousedown', inputStart);
        canvas.addEventListener('mousemove', inputMove);
        window.addEventListener('mouseup', inputEnd);
        canvas.addEventListener('touchstart', (e) => { 
            if (!e.target.closest('#hud')) e.preventDefault(); // Only prevent default if not clicking HUD
            inputStart(e); 
        }, {passive: false});
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); inputMove(e); }, {passive: false});
        window.addEventListener('touchend', inputEnd);

        // --- Game Loop Management ---
        function startGame() {
            // [CRITICAL FIX]: Play music immediately on User Interaction (Click/Touch)
            // This satisfies iOS Safari's strict autoplay policy.
            if (!isMusicPlaying) {
                // Try to play directly
                const playPromise = bgMusic.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log("Audio started successfully");
                        isMusicPlaying = true;
                        document.getElementById('musicToggle').innerText = 'ğŸµ';
                    }).catch(error => {
                        console.log("Audio play failed (will retry on next touch):", error);
                        document.getElementById('musicToggle').innerText = 'ğŸ”‡';
                        // Fallback: iOS often needs a 'touchstart' specifically if 'click' didn't work smoothly
                        document.addEventListener('touchstart', () => {
                            if(bgMusic.paused) {
                                bgMusic.play();
                                isMusicPlaying = true;
                                document.getElementById('musicToggle').innerText = 'ğŸµ';
                            }
                        }, { once: true });
                    });
                }
            }

            player.gold = 0;
            player.wave = 1;
            player.lives = 5; 
            player.stats = { count: 1, speed: 14, power: 10, fireRate: 350, pierce: 1 };
            player.upgrades = {
                count: { level: 1, cost: 200, costMult: 2.5 },
                speed: { level: 1, cost: 80, costMult: 1.6 },
                power: { level: 1, cost: 100, costMult: 1.5 },
                pierce: { level: 1, cost: 300, costMult: 3.0 }
            };

            // é‡ç½®é¡Œç›®æ± ï¼šå°‡æ‰€æœ‰é¡Œç›®çš„ç´¢å¼• (0 åˆ° 19) æ”¾é€²å»
            availableQuestions = [];
            for (let i = 0; i < quizData.length; i++) {
                availableQuestions.push(i);
            }

            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('victoryScreen').classList.add('hidden');
            
            resize();
            startWave();
            updateShopUI(); 
            
            if (animationId) cancelAnimationFrame(animationId);
            lastTime = performance.now();
            animationId = requestAnimationFrame(loop);
        }

        function resetGame() { startGame(); }

        function startWave() {
            gameState = 'PLAYING';
            projectiles = [];
            enemies = []; 
            bossSpawned = false; 
            
            enemiesToSpawn = 6 + Math.floor(player.wave * 2.2);
            spawnInterval = Math.max(300, 1500 - (player.wave * 60)); 
            spawnTimer = 0; 
            
            const notify = document.getElementById('waveNotify');
            notify.innerText = `WAVE ${player.wave}`;
            notify.style.opacity = 1;
            setTimeout(() => notify.style.opacity = 0, 2000);

            spawnEnemy(true);
            enemiesToSpawn--;

            updateHUD();
        }

        function loop(timestamp) {
            if (!timestamp) timestamp = performance.now();
            const dt = timestamp - lastTime;
            lastTime = timestamp;

            if (gameState === 'PLAYING') {
                update(dt);
            }
            draw();
            
            if (gameState === 'PLAYING') {
                animationId = requestAnimationFrame(loop);
            } else {
                animationId = null;
            }
        }

        function update(dt) {
            if (dt > 100) return;
            const now = Date.now();

            if (isInputActive) tryShoot(now);

            // Spawning
            if (enemiesToSpawn > 0) {
                spawnTimer += dt;
                if (spawnTimer >= spawnInterval) {
                    spawnEnemy();
                    spawnTimer = 0;
                    enemiesToSpawn--;
                }
            } else if (enemies.length === 0) {
                gameState = 'QUIZ';
                showQuiz();
                return;
            }

            // Projectiles
            for (let i = projectiles.length - 1; i >= 0; i--) {
                const p = projectiles[i];
                p.x += Math.cos(p.angle) * p.speed;
                p.y += Math.sin(p.angle) * p.speed;

                if (p.x < -50 || p.x > canvas.width + 50 || p.y < -50 || p.y > canvas.height + 50) {
                    projectiles.splice(i, 1);
                }
            }

            // Enemies
            for (let i = enemies.length - 1; i >= 0; i--) {
                const e = enemies[i];
                e.y += e.speed;
                
                // Zigzag Logic
                if (e.zigzag) {
                    const amp = (2 + player.wave * 0.1) * gameScale;
                    e.x += Math.sin(e.y * 0.05) * amp;
                    if (e.x < e.radius) e.x = e.radius;
                    if (e.x > canvas.width - e.radius) e.x = canvas.width - e.radius;
                }

                if (e.y > player.y - e.radius) {
                    takeDamage();
                    enemies.splice(i, 1);
                    if (player.lives <= 0) {
                        gameOver();
                        return;
                    }
                    continue; 
                }

                for (let j = projectiles.length - 1; j >= 0; j--) {
                    const p = projectiles[j];
                    const dist = Math.hypot(p.x - e.x, p.y - e.y);
                    
                    if (dist < e.radius + (15 * gameScale) && !p.hitList.includes(e.id)) {
                        e.hp -= p.damage;
                        p.hitList.push(e.id);
                        p.pierce--;

                        spawnParticles(e.x, e.y, p.color);
                        showDamage(e.x, e.y, p.damage);

                        if (p.pierce <= 0) projectiles.splice(j, 1);

                        if (e.hp <= 0) {
                            enemies.splice(i, 1);
                            player.gold += 1; 
                            updateHUD();
                            break;
                        }
                    }
                }
            }

            // Particles
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.life -= 0.1; 
                p.x += p.vx;
                p.y += p.vy;
                if (p.life <= 0) particles.splice(i, 1);
            }
        }

        function takeDamage() {
            player.lives--;
            updateHUD();
            
            gameContainer.classList.add('shake');
            damageOverlay.style.opacity = 1;
            setTimeout(() => {
                gameContainer.classList.remove('shake');
                damageOverlay.style.opacity = 0;
            }, 300);
        }

        function gameOver() {
            gameState = 'GAMEOVER';
            document.getElementById('finalWave').innerText = player.wave;
            document.getElementById('gameOverScreen').classList.remove('hidden');
        }
        
        function victory() {
            gameState = 'VICTORY';
            document.getElementById('victoryScreen').classList.remove('hidden');
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Aim Line
            if (isInputActive) {
                ctx.beginPath();
                ctx.moveTo(player.x, player.y);
                ctx.lineTo(player.x + Math.cos(player.angle) * 1000, player.y + Math.sin(player.angle) * 1000);
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
                ctx.lineWidth = 1;
                ctx.stroke();
            }

            // Player Bow (Scaled)
            ctx.save();
            ctx.translate(player.x, player.y);
            ctx.rotate(player.angle); 
            ctx.scale(gameScale, gameScale); 
            
            ctx.shadowBlur = 10; ctx.shadowColor = '#60a5fa';
            ctx.beginPath(); 
            ctx.moveTo(0, 0); ctx.quadraticCurveTo(5, -15, 25, -20); ctx.quadraticCurveTo(35, -25, 10, -45);
            ctx.moveTo(0, 0); ctx.quadraticCurveTo(5, 15, 25, 20); ctx.quadraticCurveTo(35, 25, 10, 45);
            ctx.strokeStyle = '#e2e8f0'; ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.stroke();
            ctx.shadowBlur = 0; ctx.beginPath(); 
            ctx.moveTo(0, -8); ctx.lineTo(4, 0); ctx.lineTo(0, 8); ctx.fillStyle = '#fbbf24'; ctx.fill();
            ctx.beginPath(); 
            ctx.moveTo(10, -45); ctx.lineTo(-5, 0); ctx.lineTo(10, 45);
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)'; ctx.lineWidth = 1; ctx.stroke();
            ctx.beginPath(); 
            ctx.moveTo(-5, 0); ctx.lineTo(25, 0); ctx.strokeStyle = getArrowColor(); ctx.lineWidth = 2; ctx.stroke();
            ctx.restore();

            // Projectiles
            projectiles.forEach(p => {
                ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.angle);
                ctx.beginPath(); ctx.arc(0, 0, p.radius, 0, Math.PI*2); ctx.fillStyle = p.color + '44'; ctx.fill();
                ctx.beginPath(); ctx.moveTo(-15, 0); ctx.lineTo(15, 0); ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke();
                ctx.beginPath(); ctx.moveTo(15, 0); ctx.lineTo(5, -5); ctx.lineTo(5, 5); ctx.fillStyle = p.color; ctx.fill();
                ctx.restore();
            });

            // Enemies (Scaled)
            enemies.forEach(e => {
                ctx.save();
                
                // HP Bar
                const barWidth = 40 * gameScale;
                const barHeight = 6 * gameScale;
                const barOffset = (e.radius + 10 * gameScale);
                
                ctx.fillStyle = '#4b0000';
                ctx.fillRect(e.x - barWidth/2, e.y - barOffset, barWidth, barHeight);
                const hpPct = Math.max(0, e.hp / e.maxHp);
                ctx.fillStyle = hpPct > 0.5 ? '#22c55e' : (hpPct > 0.2 ? '#eab308' : '#ef4444');
                ctx.fillRect(e.x - barWidth/2, e.y - barOffset, barWidth * hpPct, barHeight);
                
                // Emoji (Scaled font)
                ctx.font = `${e.radius * 2}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = 'white';
                ctx.fillText(e.emoji, e.x, e.y);
                
                // Boss Indicator
                if (e.radius > (40 * gameScale)) {
                    ctx.strokeStyle = 'red';
                    ctx.lineWidth = 3 * gameScale;
                    ctx.shadowColor = 'red';
                    ctx.shadowBlur = 10;
                    ctx.beginPath();
                    ctx.arc(e.x, e.y, e.radius + 5, 0, Math.PI*2);
                    ctx.stroke();
                }

                ctx.restore();
            });

            // Particles
            particles.forEach(p => {
                ctx.fillStyle = p.color; ctx.globalAlpha = p.life;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fill();
                ctx.globalAlpha = 1.0;
            });
        }

        // --- Logic ---
        function tryShoot(now) {
            if (now - lastShotTime > player.stats.fireRate) {
                shoot();
                lastShotTime = now;
            }
        }

        function shoot() {
            const count = player.stats.count;
            const spread = 0.15; 
            let startAngle = player.angle;
            for (let i = 0; i < count; i++) {
                let currentAngle = startAngle;
                if (count > 1) currentAngle = startAngle - (spread * (count - 1) / 2) + (spread * i);
                projectiles.push({
                    x: player.x + Math.cos(currentAngle) * (30 * gameScale),
                    y: player.y + Math.sin(currentAngle) * (30 * gameScale),
                    angle: currentAngle,
                    speed: player.stats.speed * speedScale,
                    radius: 5 * gameScale,
                    color: getArrowColor(),
                    damage: player.stats.power,
                    pierce: player.stats.pierce,
                    hitList: []
                });
            }
        }

        function getArrowColor() {
            if (player.stats.pierce >= 3) return '#f43f5e'; 
            if (player.stats.pierce >= 2) return '#f59e0b'; 
            return '#3b82f6'; 
        }

        function spawnEnemy(forceVisible = false) {
            const safeWidth = Math.max(canvas.width, 300); 
            let type = null;

            if (!forceVisible && player.wave % 5 === 0 && !bossSpawned) {
                if (Math.random() < 0.2 || enemiesToSpawn <= 1) {
                    type = ENEMY_TYPES.BOSS;
                    bossSpawned = true;
                }
            }

            if (!type) {
                const rand = Math.random();
                if (rand < 0.5) type = ENEMY_TYPES.NORMAL;
                else if (rand < 0.8) type = ENEMY_TYPES.FAST;
                else type = ENEMY_TYPES.TANK;
            }

            const r = type.radius * gameScale;
            const x = Math.random() * (canvas.width - r * 2) + r;
            const startY = forceVisible ? 60 : -50;

            const baseHp = 15;
            const growthFactor = Math.pow(1.28, player.wave - 1);
            const hp = Math.floor(baseHp * type.hpMult * growthFactor);

            const speedGrowth = Math.min(3.0, (player.wave - 1) * 0.1);
            const speed = (0.5 + speedGrowth) * type.speedMult * speedScale;

            enemies.push({
                id: Math.random(),
                x: x,
                y: startY,
                radius: r,
                emoji: type.emoji,
                hp: hp,
                maxHp: hp,
                speed: speed,
                color: type.color,
                zigzag: type.zigzag || false
            });
        }

        function spawnParticles(x, y, color) {
            for (let i = 0; i < 4; i++) {
                particles.push({
                    x: x, y: y,
                    vx: (Math.random() - 0.5) * 8, vy: (Math.random() - 0.5) * 8,
                    life: 1, 
                    size: (Math.random() * 3 + 1) * gameScale, 
                    color: color
                });
            }
        }

        function showDamage(x, y, dmg) {
            const el = document.createElement('div');
            el.className = 'damage-text';
            el.style.left = (x + gameContainer.offsetLeft) + 'px';
            el.style.top = (y + gameContainer.offsetTop) + 'px';
            el.innerText = `-${Math.floor(dmg)}`;
            gameContainer.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        // --- Shop System ---
        function updateHUD() {
            document.getElementById('waveVal').innerText = player.wave;
            document.getElementById('goldVal').innerText = player.gold;
            document.getElementById('livesVal').innerText = player.lives;
            updateShopUI();
        }

        function updateShopUI() {
            const types = ['count', 'speed', 'power', 'pierce'];
            types.forEach(type => {
                const upg = player.upgrades[type];
                const btn = document.getElementById(`btn-${type}`);
                document.getElementById(`cost-${type}`).innerText = Math.floor(upg.cost);
                let valDisplay = player.stats[type];
                if (type === 'fireRate') valDisplay = 'MAX'; 
                document.getElementById(`val-${type}`).innerText = valDisplay;

                if (player.gold >= Math.floor(upg.cost)) {
                    btn.disabled = false; btn.classList.add('affordable');
                } else {
                    btn.disabled = true; btn.classList.remove('affordable');
                }
            });
        }

        function buyUpgrade(type) {
            const upg = player.upgrades[type];
            const cost = Math.floor(upg.cost);
            if (player.gold >= cost) {
                player.gold -= cost;
                upg.level++;
                upg.cost *= upg.costMult; 

                if (type === 'count') player.stats.count++;
                if (type === 'speed') player.stats.speed += 1.5;
                if (type === 'power') player.stats.power += 5;
                if (type === 'pierce') player.stats.pierce++;
                if (type === 'speed') player.stats.fireRate = Math.max(100, 350 - (player.upgrades.speed.level * 15));

                updateHUD();
            }
        }

        // --- Quiz System ---
        function showQuiz() {
            const quizEl = document.getElementById('quizScreen');
            quizEl.classList.remove('hidden');
            
            // å®‰å…¨æª¢æŸ¥ï¼šå¦‚æœé¡Œç›®æ± ç©ºäº†ï¼ˆä¾‹å¦‚æ³¢æ•¸è¶…éé¡Œç›®æ•¸ï¼‰ï¼Œé‡æ–°å¡«æ»¿
            if (availableQuestions.length === 0) {
                for (let i = 0; i < quizData.length; i++) {
                    availableQuestions.push(i);
                }
            }

            // å¾å‰©ä¸‹çš„é¡Œç›®ä¸­éš¨æ©Ÿé¸ä¸€å€‹
            const poolIndex = Math.floor(Math.random() * availableQuestions.length);
            const qIndex = availableQuestions[poolIndex];
            
            // å°‡é¸ä¸­çš„é¡Œç›®å¾æ± ä¸­ç§»é™¤ï¼Œé¿å…é‡è¤‡
            availableQuestions.splice(poolIndex, 1);

            const currentQ = quizData[qIndex];

            const baseReward = 200;
            const reward = Math.floor(baseReward * Math.pow(1.35, player.wave - 1));
            document.getElementById('quizRewardVal').innerText = reward;
            
            // Allow HTML for line breaks
            document.getElementById('questionText').innerHTML = currentQ.q;
            
            const optsContainer = document.getElementById('answerOptions');
            optsContainer.innerHTML = '';
            
            // Display options
            currentQ.options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = 'quiz-btn shadow-md';
                btn.innerHTML = opt; // ä½¿ç”¨ innerHTML ä»¥æ”¯æ´ <br>
                // Check if this option index matches answer index
                const isCorrect = (index === currentQ.ans);
                btn.onclick = () => answerQuiz(isCorrect, reward);
                optsContainer.appendChild(btn);
            });
        }

        function answerQuiz(correct, reward) {
            const quizEl = document.getElementById('quizScreen');
            if (correct) {
                player.gold += reward;
                updateHUD();
            } else {
                // Optional: Penalty or just no reward
            }
            
            quizEl.classList.add('hidden');
            
            if (player.wave >= MAX_WAVE) {
                victory();
            } else {
                nextWave();
            }
        }

        function nextWave() {
            player.wave++;
            startWave();
            
            if (animationId) cancelAnimationFrame(animationId);
            lastTime = performance.now();
            animationId = requestAnimationFrame(loop);
        }

        // --- iPad/Mobile Anti-Zoom Fix ---
        // é˜²æ­¢é›™æ“Šç¸®æ”¾
        document.addEventListener('dblclick', function(event) {
            event.preventDefault();
        }, { passive: false });

        // é˜²æ­¢ Pinch ç¸®æ”¾ (Safari å°ˆç”¨)
        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });
        document.addEventListener('gesturechange', function(e) {
            e.preventDefault();
        });
        document.addEventListener('gestureend', function(e) {
            e.preventDefault();
        });

    </script>
</body>
</html>